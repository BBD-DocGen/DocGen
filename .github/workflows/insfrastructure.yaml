name: AWS-Infrastructure

on:
  push:
    branches:
      - tshego/feat/BGP-51-CICD

env:
  AWS_REGION: "eu-west-1"
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

permissions:
  id-token: write
  contents: read

jobs:
    ConfigureAwsAndTerraform:
        runs-on: ubuntu-latest
        defaults:
          run:
            working-directory: infrastructure
        steps:
            - name: Check out code
              uses: actions/checkout@v2

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                    aws-region: ${{ env.AWS_REGION }}
                    aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
                    aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
                    audience: sts.amazonaws.com

            - name: Check out terraform
              uses: hashicorp/setup-terraform@v3
 
            - name: Terraform Init
              run: terraform init

            - name: Terraform Plan
              id: plan
              run: terraform plan

            - name: Terraform Apply
              run: terraform apply -auto-approve

    DeployAPI:
      name: Build & Deploy
      needs: ConfigureAwsAndTerraform
      runs-on: ubuntu-latest
      defaults:
        run:
          working-directory: DocGenApi
      steps:
      - name: Checkout source code
        uses: actions/checkout@v2
      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'
      - name: Publish
        run: dotnet publish DocGen.API -o site
      - name: Generate deployment package
        run: cd site; zip -r ../deploy.zip . -x '*.git*'; cd ..
      - name: Upload .NET to artifact
        uses: actions/upload-artifact@v3
        with:
          name: dotnet-zip
          path: deploy.zip
      - name: Setup EB CLI
        run: |
          python --version
          pip --version
          pip install awsebcli --upgrade --user
          eb --version
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2 # More information on this action can be found below in the 'AWS Credentials' section
        with:
          aws-region: ${{ env.AWS_REGION }}
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          audience: sts.amazonaws.com
      - name: Deploy to EB
        run: eb deploy dotnet-env-dev --staged

      


  